# Смена текущей сцены и состояния игры

Золотое правило: никогда не уничтожайте текущую сцену и не меняйте состояние игры посередине игрового цикла.

Рассмотрим пример:

```
class Game : public Application
{
    void HandleUpdae(...)
    {
        Если была нажата клавиша ESC и состояние игры == игровой процесс,
            то состояние игры = главное меню.
    }
}

class UILogic : public LogicComponent
{
    void Update(...)
    {
        Если была нажата клавиша ESC и состояние игры == главное меню,
            то состояние игры = игровой процесс.
    }
}
```

Получается, что если игрок нажмет клавишу ESC, то это нажатие обработается дважды в разных местах
программы и в итоге главное меню игрок так и не увидит. Ситуация, когда половина игрового цикла
выполняется в одном состоянии игры, а другая в другом, может привести к серьезным логическим ошибкам
и разрешить их будет крайне проблематично. А для более-менее большого проекта с множеством компонентов
уследить за всеми логическими связями и разобраться с ошибками, когда куски кода срабатывают в разных
игровых состояниях вообще нереально.

Решением этого будет не менять состояние игры мгновенно, а хранить требуемое состояние в
дополнительной переменной и фактическую смену состояния производить в начале следующей итерации игрового цикла
до обработки любых событий, а именно в обработчике события `E_POSTBEGINFRAME`.

Другая ситуация: игрок нажал на кнопку и ему нужно перейти на следующий уровень.
Если в обработчике одного из событий вы попытаетесь удалить из памяти текущую сцену и загрузить другую,
то игра может вообще вылететь, когда движок, идя дальше циклу, попытается обратиться к объектам, которые уже не существуют.
Проблема решается аналогичным способом.

**Теги: Dviglo, события**
